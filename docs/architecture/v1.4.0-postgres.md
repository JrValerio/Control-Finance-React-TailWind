# Arquitetura v1.4.0 (Postgres Persistence)

## Objetivo
Migrar persistencia de usuarios e transacoes do modo em memoria para Postgres, mantendo JWT e isolamento por usuario.

## Backend (`apps/api`)

- `db/index.js`: conexao central com Postgres via `pg` (`DATABASE_URL` obrigatoria).
  - SSL configuravel via `DB_SSL` (com fallback para producao/`sslmode=require`).
- `db/migrate.js`: runner de migrations SQL com controle em `schema_migrations`.
- `db/migrations/001_create_users_and_transactions.sql`:
  - tabela `users`
  - tabela `transactions` (FK `user_id` -> `users.id`)
  - indice `idx_transactions_user_id`
- `db/seed.js`: seed minima para ambiente de desenvolvimento.

## Servicos migrados

- `auth.service.js`:
  - `registerUser` grava em `users` com hash bcrypt
  - `loginUser` consulta `users` e emite JWT
- `transactions.service.js`:
  - `listTransactionsByUser`
  - `createTransactionForUser`
  - `deleteTransactionForUser`
  - todos operando em Postgres e filtrando por `userId`

## Fluxo de inicializacao

`src/server.js` executa `runMigrations()` antes de iniciar o listener HTTP.

## Versionamento da API

`GET /health` resolve a versao a partir do `apps/api/package.json`, evitando hardcode manual.

## Testes

- `app.test.js` usa `pg-mem` como banco de teste.
- migrations reais sao aplicadas no setup de testes.
- cenarios cobrem auth, CRUD de transacoes e isolamento entre usuarios.
