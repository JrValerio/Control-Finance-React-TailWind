# Arquitetura v1.5.0 (Export CSV + filtros API)

## Objetivo

Adicionar exportacao CSV de transacoes com filtros server-side e totais consolidados no proprio arquivo.

## Escopo

- API:
  - `GET /transactions` com filtros opcionais por `type`, `from`, `to`, `q` e `includeDeleted`
  - `GET /transactions/export.csv` para download de CSV com os mesmos filtros
- Web:
  - Botao `Exportar CSV` no dashboard
  - Exportacao com filtros ativos (categoria + periodo)
  - Download de arquivo com nome retornado pela API

## Backend (apps/api)

### Filtros unificados

`transactions.service.js` passou a normalizar filtros em um unico fluxo:

- `type`: `Entrada` ou `Saida`
- `from` / `to`: formato `YYYY-MM-DD` (com swap automatico quando invertido)
- `q`: busca textual por `description` e `notes` (case-insensitive via `ILIKE`)
- `includeDeleted`: inclui removidos por soft delete quando `true`

### Export CSV

Novo metodo `exportTransactionsCsvByUser`:

- reaproveita os filtros da listagem
- gera CSV UTF-8 com BOM
- escapa campos com virgula, aspas e quebra de linha
- adiciona bloco final de resumo:
  - `total_entradas`
  - `total_saidas`
  - `saldo`

### Rota

`apps/api/src/routes/transactions.routes.js`:

- `GET /transactions/export.csv` (autenticada)
- headers de download:
  - `Content-Type: text/csv; charset=utf-8`
  - `Content-Disposition: attachment; filename="..."`

## Frontend (apps/web)

### Service layer

`transactions.service.js` recebeu `exportCsv(options)`:

- envia filtros por query string
- recebe blob (`responseType: "blob"`)
- extrai nome de arquivo de `content-disposition`

### Dashboard

`App.jsx`:

- novo botao `Exportar CSV`
- bloqueio de clique durante exportacao (`isExportingCsv`)
- reutiliza filtro ativo para montar payload de export:
  - categoria (`type`)
  - periodo (`from`/`to` via `resolvePeriodRange`)

## Testes

### API

- filtro combinado (`type + from/to + q`) em `GET /transactions`
- validacao de export CSV (headers, dados filtrados, escape e totais)

### Web

- validacao do clique em `Exportar CSV`
- garante chamada do service com filtros ativos
- valida ciclo de download (`createObjectURL`, `click`, `revokeObjectURL`)

## Resultado

v1.5.0 adiciona exportacao orientada a uso real sem alterar contratos existentes de criacao/edicao/exclusao de transacoes.
